# iluhabot5.3 — серверная логика user_data.json (merge с old_version)

**Цель:** перенести и объединить _только_ серверную логику работы с `user_data.json` (запись/чтение, поля Telegram: avatar `photo_url`, `username`) из `old_version.zip` в действующий проект `iluhabot5.2.zip`, не затрагивая остальной функционал и дизайн. Дополнительно добавлены:

- Поле выбора часового пояса пользователя `utc_offset` (например, `UTC-03:00`).
- Поддержка языка **pt** (Português) и региона **BRAZIL** (на уровне данных/валидации API).
- Надёжная обработка частичных данных (см. ниже).

> ⚠️ В этом архиве изменён **только сервер** (`server.js`). Остальной функционал, структура и дизайн оставлены без изменений относительно `iluhabot5.2.zip`.

---

## Быстрый запуск

Требования: **Node.js ≥ 18**, **npm**, (опционально для бота: **Python ≥ 3.10**).

1. Установите зависимости:
   ```bash
   npm install
   ```

2. Запустите API‑сервер (порт по умолчанию: `3000`):
   ```bash
   node server.js
   ```

3. (Опционально) Запустите Telegram‑бота:
   ```bash
   pip install -r requirements.txt
   TELEGRAM_BOT_TOKEN=xxx python bot.py
   ```

4. Фронтенд поднимайте отдельно (как и раньше) — например:
   ```bash
   cd web && python -m http.server 8000
   ```
   При открытии фронтенда на `8000` мини‑приложение должно бить запросы в API на `http://localhost:3000` (как и прежде).

---

## API (совместимость сохранена)

### Базовые пути
- `GET /` → `{ status:'ok', file: <путь к user_data.json> }`
- `GET /api/users?user_id=<id>&telegram_id=<id>` — получить всех/одного пользователя
- `POST /api/users` — upsert пользователя (частичное обновление)
- `PUT /api/users/:id/status` — изменить `reels_status` (выставляет `moderated_at`)

### Совместимость с **old_version**
- `POST /save_user_data` — эквивалент `POST /api/users` (по `telegram_id`)
- `GET /get_user_data?telegram_id=<id>` — получить пользователя по `telegram_id`
- `GET /debug/users` — отладочный дамп файла JSON

### Поля пользователя (поддерживаются сервером)
```
{
  telegram_id, user_id, username, first_name, photo_url,
  region, language, utc_offset,
  referrals: [], referrer_id,
  points_total, points_current, daily_points, last_reset,
  reels_link, reels_status,
  updated_at, moderated_at, last_online
}
```
- `reels_link` проверяется на формат `https://www.instagram.com/reel/...`
- `utc_offset` в формате `UTC±HH:MM` (например, `UTC-03:00`)
- `language`: `en|es|fr|pt`; `region`: `USA|Mexico|Canada|BRAZIL`
- При смене `reels_status` сервер проставляет `moderated_at`.
- Сервер **не затирает валидные старые значения**, если пришли пустые/невалидные данные (см. ниже).

---

## Поведение при частичной/неполной отправке данных

Сервер реализует _защитное объединение_ записей (merge):
- Строковые поля принимаются только если **не пустые** (не `""`, не `null`/`undefined`). Иначе — оставляет прежнее значение.
- Числовые поля (`points_total`, `points_current`, `daily_points`) принимаются только если это **конечные числа**.
- Массивы (`referrals`) принимаются только если это **массив**.
- `reels_link` должен начинаться с `https://www.instagram.com/reel/`.
- `utc_offset` должен соответствовать `UTC±HH:MM`.
- `updated_at` и `last_online` обновляются на сервере всегда.
- Совместимость со старыми полями `points` сохранена: если приходит `points`, он мапится в `points_total` (и в `points_current`, если тот пуст).

Таким образом, если пришло неполное тело запроса, сервер аккуратно **дополнит запись** только теми полями, которые валидны, не затирая корректные старые данные пустыми/невалидными значениями.

---

## Где лежит хранилище

`user_data/user_data.json` (создаётся автоматически). Запись реализована атомарно через временный файл (`*.tmp`) и последующее переименование — по аналогии с `old_version`.

---

## Пример данных

См. `sample_data/test_users.json` — актуальный пример заполнения (с реальными полями Telegram, регионом **BRAZIL**, языком **pt** и часовым поясом `UTC-03:00`).

---

## Changelog (по сравнению с iluhabot5.2)

- Перенесена файловая логика из `old_version` (надёжное чтение/запись, атомарное сохранение, автосоздание каталога).
- Объединённая схема данных пользователя (поддержка `photo_url`, `username`, `utc_offset`, `points_total/points_current`, совместимость со старым `points`).
- Добавлены бэкенд‑валидации: `reels_link`, формат `utc_offset`.
- Сохранена совместимость API: `POST /save_user_data`, `GET /get_user_data` работают как раньше.
- Добавлен отладочный эндпоинт `GET /debug/users`.
- README переписан на русском: инструкции запуска и поведение при неполных данных.

---

## Примечания
- Дизайн и фронтенд‑логика **не менялись** в рамках задачи (требование).
- Поддержка языка **pt** и региона **BRAZIL** добавлена на стороне сервера/данных. Для показа на экране выбора в мини‑приложении потребуется внести изменения во фронтенд (добавить вариант языка и региона + часовой пояс) — по требованию добавьте эти изменения в UI отдельно.

